import pytest


@pytest.mark.django_db
def test_create_user(client):
    # Given
    user_payload = {
        "name": "Bob",
        "email": "bob@example.com",
	"password": "I_am_Bob",
    }

    # When
    response = client.post(
        "/core/user/create/",
        user_payload,
        content_type="application/json",
    )
    
    # Then
    assert response.status_code == 201
    created_user = response.json()
    
    assert created_user["name"] == "Bob"
    assert created_user["id"] is not None
    
    # Verification: Is it in base
    # 2 methods:
    # 1) Check in base
    from core.models import FitUser
    assert FitUser.objects.count() == 1
    assert FitUser.objects.first().user.username == "Bob"

    # 2) Make API call
    response = client.get(f"/core/user/get/?id={created_user['id']}", content_type="application/json")

    assert response.status_code == 200
    assert response.json() == {
        "id": created_user["id"],
        "name": "Bob",
        "birthday": "1990-01-01",
        "email": "bob@example.com",
        "role": "",
        "city": "Paris",
        "credits": 0,
    }
